# SOP: MiniZinc Debugging and Data Generation

## 1. Purpose
This Standard Operating Procedure (SOP) outlines the systematic process for debugging MiniZinc models and their associated data files (`.dzn`) generated by the `doc_to_minizinc_data` Rust program. The goal is to ensure correct data formatting and successful MiniZinc model execution.

## 2. Scope
This SOP applies to all MiniZinc models (`.mzn`) and data files (`.dzn`) within the `libminizinc` project, specifically focusing on issues arising from data generation by `doc_to_minizinc_data`.

## 3. Procedure

### Phase 1: Problem Identification and Initial Analysis

1.  **Observe MiniZinc Error:** Identify the specific error message from the MiniZinc solver output (e.g., `syntax error`, `type error`, `symbol error`). Note the file and line number if provided.
    *   **Tool:** `run_shell_command` (for `run_minizinc_chunks.sh` output).

2.  **Inspect MiniZinc Model (`.mzn`):** Review the MiniZinc model (`word_embedding_inference.mzn` or other relevant `.mzn` files) at the reported line number. Understand what data it expects and how it uses the variables mentioned in the error.
    *   **Tool:** `read_file` (for `.mzn` file).

3.  **Inspect Generated Data File (`.dzn`):** Examine the content of the `.dzn` file that is causing the error (e.g., `logical_relationships.dzn`, `word_embeddings_chunk_X.dzn`). Compare its format and variable definitions against the expectations of the MiniZinc model. Pay close attention to:
    *   Array syntax (e.g., `[| ... |]` for 2D arrays of tuples, `[...]` for 1D arrays).
    *   String formatting (e.g., double quotes `"`).
    *   Variable names and types.
    *   **Tool:** `read_file` (for `.dzn` file).

### Phase 2: Rust Source Code Modification (Data Generation Logic)

1.  **Locate Relevant Rust Code:** Identify the section within `doc_to_minizinc_data/src/main.rs` (or other relevant Rust source files) responsible for generating the problematic `.dzn` content.
    *   **Tool:** `read_file` (for `doc_to_minizinc_data/src/main.rs`).

2.  **Modify Rust Code:** Adjust the Rust code to ensure the generated `.dzn` file adheres to the correct MiniZinc syntax and variable definitions. This often involves:
    *   Correcting `format!` macros for string or array formatting.
    *   Adjusting `join` strings for array elements or tuple separators.
    *   Ensuring all expected variables are declared and assigned values.
    *   **Tool:** `replace` (for `doc_to_minizinc_data/src/main.rs`). Use `expected_replacements` if multiple occurrences need to be changed. Provide sufficient context in `old_string` to ensure precise targeting.

### Phase 3: Rebuild and Regenerate

1.  **Rebuild Rust Program:** Compile the modified `doc_to_minizinc_data` Rust program.
    *   **Tool:** `run_shell_command` (for `cargo build --package doc_to_minizinc_data`).

2.  **Regenerate Data Files:** Execute the rebuilt `doc_to_minizinc_data` program to generate new `.dzn` files with the corrected formatting.
    *   **Tool:** `run_shell_command` (for `./target/debug/doc_to_minizinc_data`).

### Phase 4: Verification

1.  **Re-run MiniZinc:** Execute the script that runs the MiniZinc model with the newly generated data files.
    *   **Tool:** `run_shell_command` (for `run_minizinc_chunks.sh`).

2.  **Verify Output:** Check the MiniZinc solver output for successful execution or new error messages. If new errors occur, return to Phase 1.

## 4. Tools
*   `run_shell_command`
*   `read_file`
*   `replace`

## 5. Expected Outcome
*   Successful execution of MiniZinc models without syntax or type errors related to data files.
*   Correctly formatted `.dzn` files.
*   Improved understanding of MiniZinc data expectations and Rust data generation.
