stages:
  - build
  - test

build:linux:
  stage: build
  image: gcc:latest
  before_script:
    - apt-get update && apt-get -y install cmake
  script:
    - mkdir build
    - cd build
    - cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=$PWD/..
    - cmake --build . --target install -- -j4
  artifacts:
     paths:
       - bin/
  tags:
     - linux

build:osx:
  stage: build
  script:
    - mkdir build
    - cd build
    - cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=$PWD/..
    - cmake --build . --target install -- -j4
  artifacts:
     paths:
       - bin/
  tags:
     - mac

build:windows:
  stage: build
  script:
    - mkdir build
    - cd build
    - cmake .. -G"Visual Studio 14 2015 Win64" -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=..
    - cmake --build . --config Release --target install
  artifacts:
     paths:
       - bin/
  tags:
     - windows


# TODO: Fix tests
# test:mzn20_fd:linux:
#   stage: test
#   image: ubuntu:latest
#   script:
#      - cd tests
#      - export PATH="$(pwd)/../bin":"$(pwd)/scripts":"$PATH"
#      - bash run-tests mzn20_fd .mzn unit examples
#   dependencies:
#      - build:linux
#   tags:
#      - linux
#
# test:mzn-fzn_fd:linux:
#   stage: test
#   image: ubuntu:latest
#   script:
#      - cd tests
#      - export PATH="$(pwd)/../bin":"$(pwd)/scripts":"$PATH"
#      - bash run-tests mzn-fzn_fd .mzn unit examples
#   dependencies:
#      - build:linux
#   tags:
#      - linux
#
# test:mzn20_fd:osx:
#   stage: test
#   script:
#      - cd tests
#      - export PATH="$(pwd)/../bin":"$(pwd)/scripts":"$PATH"
#      - bash run-tests mzn20_fd .mzn unit examples
#   dependencies:
#      - build:osx
#   tags:
#      - mac
#
# test:mzn-fzn_fd:osx:
#   stage: test
#   script:
#      - cd tests
#      - export PATH="$(pwd)/../bin":"$(pwd)/scripts":"$PATH"
#      - bash run-tests mzn-fzn_fd .mzn unit examples
#   dependencies:
#      - build:osx
#   tags:
#      - mac
